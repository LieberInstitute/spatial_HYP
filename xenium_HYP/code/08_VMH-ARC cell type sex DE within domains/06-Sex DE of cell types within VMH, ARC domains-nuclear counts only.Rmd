---
title: "06-Sex DE of cell types within VMH, ARC domains-nuclear counts only"
output: html_document
date: "2024-07-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(Biostrings)
library(ggplot2)
library(gridExtra)
library(MoleculeExperiment)
library(SpatialExperiment)
library(SpatialFeatureExperiment)
library(dreamlet)

## rstudio GUI tweaks
require(colorout)
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")
##

## enable forked parallel processing with BiocParallel::multicoreParam, future::, etc. seemed to need this a couple times, but otherwise havent so its here as a preventative measure.
library(parallelly)
options(parallelly.supportsMulticore.disableOn="")
options(parallelly.fork.enable=TRUE)
library(BiocParallel)
options(bphost="localhost")

## ggplot defaults
theme_set(theme_bw()+theme(axis.text.x = element_text(size = 14), axis.title.x = element_text(size = 16), axis.text.y = element_text(size = 14), axis.title.y = element_text(size =16), plot.title = element_text(size = 20,hjust=0.5), strip.text = element_text(size=18), legend.text = element_text(size=10), legend.title = element_text(size=11,hjust=0.5)))
```

### to get nuclear counts, we will use the slightly clunky but efficient MoleculeExperiment package to read in transcript detections, subset them by quality score >20 (qv--the raw transcripts-detected-by-location-table does not filter for this, though the tabulated counts per cell we've used up to now already are filtered thusly), and then tabulate the counts within the nuclear boundaries. 

the key xenium output files being used behind the scenes here are in processed-data/01/[resegmented sample]/outs/transcripts.csv.gz and nucleus_boundaries.csv.gz .

### performance notes: request 2 more cores than specified in countMolecules below; peak RAM usage with 10 cores approx 80GB
```{r}
xenouts <- list.files(pattern="wnuclei",path="processed-data/01_xeniumranger1.7-resegment",full.names=T)
xenouts <- paste0(xenouts,"/outs")

xens <- lapply(xenouts,FUN=function(x){
    xendat <- MoleculeExperiment::readXenium(x,keepCols="all",addBoundaries="nucleus")
    ## drop controls etc
    xendat@molecules$detected$outs <- xendat@molecules$detected$outs[grep(names(xendat@molecules$detected$outs),pattern="unassigned|deprecated|BLANK|control",ignore.case = T,value=T,invert=T)]
    ## filter by qv
    xendat@molecules$detected$outs <- lapply(xendat@molecules$detected$outs, FUN=function(g){return(g[which(g$qv>20),])})
    
    ## tabulate to nuclear counts using countMolecules, which will return a spatialExperiment object
    ## note that inexplicably the countMolecules function uses two more cores than whatever the user specifies.
    xendat <- countMolecules(xendat,moleculesAssay="detected",boundariesAssay="nucleus",nCores = 8)
    
    ## assign sample name matched to the sample names we've been using; assign cell_ids as unique identifiers (sampleid_cellid) and then as colnames of the SPE
    sampn <- gsub(x,pattern=".*02_(.*)",replacement="\\1")
    sampn <- gsub(sampn,pattern="|.*03_(.*)",replacement="\\1")
    sampn <- gsub(sampn,pattern="^(.*)_reseg.*$",replacement="\\1")
    sampn <- gsub(sampn,pattern="^(.*)_xr17.*$",replacement="\\1")
    sampn <- paste0("X",sampn)
    
    colData(xendat)$sample_id <- sampn
    colData(xendat)$cell_id <- gsub(colData(xendat)$cell_id,pattern="^outs\\.(.*)$",replacement=paste0(sampn,"_","\\1"))
    colnames(xendat) <- colData(xendat)$cell_id
    
    return(xendat)
})

```

### concatenate to a single multisample SPE
### append additional metadata (sex being the important one)
### append cell clusters / discard cells in the "discard" clusters
```{r}
i<-1
for (i in c(1:length(xens))){
    if(i==1){
        fullnuc <- xens[[i]]
    }
    else{fullnuc <- cbind(fullnuc,xens[[i]])}
}

### check that we have 870870 (or more) total "cells" (nuclei) in the joined SPE--which was the size of the final SFE after filtering etc.
dim(fullnuc)

###
# 366 912692

##  since there's more than the SFE's number of nuclei, this SPE includes ones that we previously discarded by e.g. filtering for erratic nuclear/cell segmentations, nucleus area:cell area ratios, etc. quick read in the working cell-level SFE to get the identifiers to keep
hypb <- readRDS("processed-data/05_Banksy_M0lam0_res2_multisamp/01-sfe-in_staggered-coords_genetarg-only_NONlog-norm.RDS")

retaincells <- colnames(hypb)
rm(hypb)
gc(full=T)
##
stopifnot(all(retaincells %in% colnames(fullnuc)))
fullnuc <- fullnuc[,retaincells]

## now read in the clustering results, plain-english annotations of them, and the domain-cell assignments made using the 4 non-periventricular ARC cell types
bkcl <- fread("processed-data/05_Banksy_M0lam0_res2_multisamp/01-BanksyClusts_M0lam0_leiden_multisamp.txt")

bkanno <- fread("processed-data/05_Banksy_M0lam0_res2_multisamp/02-M0l0kg6_topClusMarkers_celltypes_annotated.txt")
bkanno <- unique(bkanno[,.(clus,bjm_annot)])
bkanno[,clus:=paste0("X",clus)]

## append cell type annots to the labels
bkcl <- merge.data.table(bkcl,bkanno,by.x="M0lam0_leiden_multisamp_res2",by.y="clus",all.x=T)
## drop rows corresponding to cells from the clusters to be discarded (sample specific clusters etc)
bkcl <- bkcl[bjm_annot!="DISCARD"]

## subset the SPE to the remaining cells
fullnuc <- fullnuc[,bkcl$rn]

## label cell types in the SPE
bkcl <- DataFrame(bkcl,row.names=bkcl$rn)
bkcl <- bkcl[colnames(fullnuc),]
colLabels(fullnuc) <- bkcl$M0lam0_leiden_multisamp_res2

## append metadata (sex, brnum for donor ranfx model)
demos <- fread("raw-data/demos_and_xeniumrun_metadata.tsv")
demos <- demos[,.(sample_name_SFEonly,BrNum,Sex)]
stopifnot(all(unique(fullnuc$sample_id) %in% demos$sample_name_SFEonly))

tmpcd <- as.data.table(colData(fullnuc),keep.rownames=T)
tmpcd <- merge.data.table(tmpcd,demos,by.x="sample_id",by.y="sample_name_SFEonly",all.x=T)
tmpcd <- DataFrame(tmpcd,row.names=tmpcd$rn)
tmpcd <- tmpcd[colnames(fullnuc),]
colData(fullnuc) <- tmpcd

rm(i,retaincells,xenouts,bkcl,doms,tmpcd,demos)

## read in domain assignments subsetted to the retained cells, and append to SPE; subset to SPE of only cells in a domain for within-domain cell type sex DE
doms <- fread("processed-data/07_Domains-subdomains_by_knnSmoothing_Banksytypes/03b-ARCVMHdomains_2stepsmooth_VMH-k10-0.2-VMH-k200-0.2_ARC-k50-0.1_ARC-k500-0.5.txt")

doms <- doms[rn %in% colnames(fullnuc),]

doms <- DataFrame(doms,row.names=doms$rn)
doms <- doms[colnames(fullnuc),]
fullnuc$domain <- doms$dualVMHARC4

hypnuc.vdom <- fullnuc[,fullnuc$domain=="VMH"]
hypnuc.adom <- fullnuc[,fullnuc$domain=="ARC"]


```

```{r}
hypnuc.adom.ag <- dreamlet::aggregateToPseudoBulk(hypnuc.adom,assay="counts",sample_id="sample_id",cluster_id = "label",BPPARAM = MulticoreParam(8))


## min samples 5 -- size of the smaller sex group in total samps (females)-- one female sample has ~no ARC with this smoothing unfortunately
dl.rf <- dreamlet::processAssays(hypnuc.adom.ag,min.cells = 10,min.count = 10,min.samples = 5,min.prop = 0.4,normalize.method = "TMM",useCountsWeights = T,BPPARAM = MulticoreParam(8),formula = ~Sex+(1|BrNum))

### Warning message: In dreamlet::processAssays(hyp.adom.ag, min.cells = 10, min.count = 10,  : Not enough samples retained or model fit fails: X28, X30, X34, X36, X37, X40

dl.rf <- dreamlet::dreamlet(dl.rf,formula = ~Sex+(1|BrNum),BPPARAM = MulticoreParam(8))

dl.rf.res <- dreamlet::topTable(dl.rf,coef="SexMale",number=Inf,adjust.method ="BH")
dl.rf.res <- as.data.table(dl.rf.res)

## append rowData, domain, cell type annots to result table
dl.rf.res[,domain:="ARC_4typeDomain_nuclearCounts"]

dl.rf.res <- merge.data.table(dl.rf.res,bkanno,by.x="assay",by.y="clus",all.x=T)
setnames(dl.rf.res,"logFC","logFC_MvF")

dl.rf.res.nucadom <- copy(dl.rf.res)
```

## same for the dually assigned VMH
```{r}
hypnuc.vdom.ag <- dreamlet::aggregateToPseudoBulk(hypnuc.vdom,assay="counts",sample_id="sample_id",cluster_id = "label",BPPARAM = MulticoreParam(8))


## min samples 6 -- size of the smaller sex group in total samps (females)
dl.rf <- dreamlet::processAssays(hypnuc.vdom.ag,min.cells = 10,min.count = 10,min.samples = 6,min.prop = 0.4,normalize.method = "TMM",useCountsWeights = T,BPPARAM = MulticoreParam(8),formula = ~Sex+(1|BrNum))

### Warning messages flooded with In simpleLoess(y, x, w, span, degree = degree, parametric = parametric,  ... : Chernobyl! trL>n 9 ?

dl.rf <- dreamlet::dreamlet(dl.rf,formula = ~Sex+(1|BrNum),BPPARAM = MulticoreParam(8))

dl.rf.res <- dreamlet::topTable(dl.rf,coef="SexMale",number=Inf,adjust.method ="BH")
dl.rf.res <- as.data.table(dl.rf.res)

## append rowData, domain, cell type annots to result table
dl.rf.res[,domain:="VMH_4typeDomain_nuclearCounts"]

dl.rf.res <- merge.data.table(dl.rf.res,bkanno,by.x="assay",by.y="clus",all.x=T)
setnames(dl.rf.res,"logFC","logFC_MvF")

dl.rf.res.nucvdom <- copy(dl.rf.res)
```

### concat and save
```{r}
dl.rf.res.nucadom <- dl.rf.res.nucadom[,.(assay,bjm_annot,ID,logFC_MvF,adj.P.Val,t,P.Value)]

setnames(dl.rf.res.nucadom,c("logFC_MvF","adj.P.Val","t","P.Value"),c("logFC_MvF_inARCnuc","FDR_inARCnuc","t_inARCnuc","P.Value_inARCnuc"))

dl.rf.res.nucvdom <- dl.rf.res.nucvdom[,.(assay,bjm_annot,ID,logFC_MvF,adj.P.Val,t,P.Value)]

setnames(dl.rf.res.nucvdom,c("logFC_MvF","adj.P.Val","t","P.Value"),c("logFC_MvF_inVMHnuc","FDR_inVMHnuc","t_inVMHnuc","P.Value_inVMHnuc"))

sexDEnuc_indom <- merge.data.table(dl.rf.res.nucadom,dl.rf.res.nucvdom,by=c("assay","bjm_annot","ID"),all.x=T,all.y=T)

## save
fwrite(sexDEnuc_indom,"processed-data/08_VMH-ARC cell type sex DE within domains/06-4celltypeARC-and-VMH-dualassignedDomains_celltypeSexDE_nuclearcounts.txt")
```


