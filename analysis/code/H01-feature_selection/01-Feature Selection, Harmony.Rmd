---
title: "01-Feature Selection (Harmony)"
author: "Bernie Mulvey"
date: "2023-05-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
knitr::opts_chunk$set(fig.width=7,fig.height=10)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(ggplot2)
library(data.table)
library(Biostrings)
library(gridExtra)
require(colorout)
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")
library(SpatialExperiment)
library(ggspavis)
library(scater) # addPerCellQC
# library(nnSVG)
library(BiocParallel)
library(scran)
library(parallel)
# library(scCustomize)
# library(fasthplus)
# library(STexampleData)
library(harmony)

theme_set(theme_bw()+theme(axis.text.x = element_text(size = 14), axis.title.x = element_text(size = 16), axis.text.y = element_text(size = 14), axis.title.y = element_text(size =16), plot.title = element_text(size = 20,hjust=0.5), strip.text = element_text(size=18), legend.text = element_text(size=10), legend.title = element_text(size=11,hjust=0.5)))
```


```{r}
hyp2 <- readRDS("data/processing/hyp_umi600_gene450_chrm35_lognorm_053123.RDS")
demos <- fread("raw-data/demos.txt")

demos <- demos[BrNum %in% colData(hyp2)$brnum]
setnames(demos,"BrNum","brnum")
demos <- as.data.frame(demos)

tmp <- merge(colData(hyp2)[,c("brnum","sample_id","key")],demos,by="brnum")
# ^ has no rownames. and they need to be unique anyhow, so change hyp2 colnames and rownames(colData to $key:
colnames(hyp2) <- colData(hyp2)$key
rownames(colData(hyp2)) <- colData(hyp2)$key

# check if they're same order. prob not.
rownames(tmp) <- tmp$key
sum(rownames(tmp)==colData(hyp2)$key) # 0
sortrn <- rownames(colData(hyp2))
# reorder
tmp <- tmp[sortrn,]
stopifnot(sum(rownames(tmp)==colData(hyp2)$key)==nrow(colData(hyp2)))
#
colData(hyp2) <- cbind(colData(hyp2),tmp)

colnames(colData(hyp2))
# double check using the two key columns now in coldata
colnames(colData(hyp2))[33] <- "key2"
stopifnot((sum(colData(hyp2)$key==colData(hyp2)$key2))==nrow(colData(hyp2)))
# k. also fix "Best Rin PFC" and "BMI (calculated)" to not have spaces; drop other repeat columns and label column
colnames(colData(hyp2))[c(39,40)] <- c("best_rin_pfc","bmi")
colData(hyp2) <- colData(hyp2)[,c(1:30,34:40)]
rm(tmp,demos,sortrn)
```

### mean-variance relationships: blocking on sample_id for gene variances, to account for tech variance between the multiple replicates from a couple donors. 
### Subsequently with harmony, use brnum for blocking since duplicate variances should have been accounted for in the hvg identification from sample-blocked variance. 
```{r}
hyp2.vars <- modelGeneVar(hyp2,block=hyp2$sample_id)

varperblock <- hyp2.vars$per.block
plts <- list()

rn <- rownames(varperblock[[1]])

i <- 1
for (i in c(1:length(varperblock))){
    hyp2.vars.dt <- cbind(as.data.table(as.character(rownames(varperblock[[i]]))),varperblock[[i]]$total)
    hyp2.means.dt <- cbind(as.data.table(as.character(rownames(varperblock[[i]]))),varperblock[[i]]$mean)

    setnames(hyp2.vars.dt,2,"var_log_xpr")
    setnames(hyp2.means.dt,2,"mean_log_xpr")
    hyp2.mnvar.pltdat <- merge(hyp2.means.dt,hyp2.vars.dt,by="V1")
    plts[[i]] <- ggplot(hyp2.mnvar.pltdat, aes(x = mean_log_xpr, y = var_log_xpr)) +
        geom_point() +
        geom_function(fun=metadata(varperblock[[i]])$trend,col="blue")+
        ggtitle(paste0("Mean-var curve-",names(varperblock)[i],"\n sample_id blocking"))
    rm(hyp2.mnvar.pltdat,hyp2.vars.dt,hyp2.means.dt)
}

library(gridExtra)
pdf("plots/H01-feature_selection_and_harmony/samplewiseblocking_meanvars.pdf",height=14,width=10)
do.call("grid.arrange",c(plts,nrow=4,ncol=2))
dev.off()
rm(plts,varperblock)
```

get top 10, 20 %ile HVGs from sample_id-blocking'd variances
```{r}
hyp2.hvg10 <- scran::getTopHVGs(hyp2.vars,prop = 0.1)
hyp2.hvg20 <- scran::getTopHVGs(hyp2.vars,prop=0.2)


saveRDS(hyp2.hvg10,"analysis/data/H01-feature_selection/HVG10pctile_sample-blocked.RDS")
saveRDS(hyp2.hvg20,"analysis/data/H01-feature_selection/HVG20pctile_sample-blocked.RDS")

pcas <- list()
set.seed(42)
pcas[[1]] <- scater::runPCA(hyp2,subset_row=hyp2.hvg10)
set.seed(42)
pcas[[2]] <- scater::runPCA(hyp2,subset_row=hyp2.hvg20)

set.seed(42)
pcas[[1]] <- scater::runUMAP(pcas[[1]],dimred="PCA")
set.seed(42)
pcas[[2]] <- scater::runUMAP(pcas[[2]],dimred="PCA")

set.seed(42)
pcas[[1]] <- RunHarmony(pcas[[1]],group.by.vars = "brnum")
set.seed(42)
pcas[[2]] <- RunHarmony(pcas[[2]],group.by.vars = "brnum")

set.seed(42)
pcas[[1]] <- scater::runUMAP(pcas[[1]],dimred="HARMONY",name="HARMONY_UMAP")
set.seed(42)
pcas[[2]] <- scater::runUMAP(pcas[[2]],dimred="HARMONY",name="HARMONY_UMAP")

names(pcas) <- c("hvg10pctile","hvg20pctile")

# saveRDS(pcas,"analysis/data/H01-feature_selection/SPEs_sampleBlock-hvgs-10or20pctile_brnumBlock-Harmony-PCA-UMAP.RDS")

rm(hyp2,hyp2.vars,hyp2.hvg10,hyp2.hvg20,i,rn)
gc(full=T)
```
