---
title: "02-Compare human sex DE to Yao23 mouse sex DE by subclass or supertype"
author: "Bernard Mulvey"
date: "2023-08-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
knitr::opts_chunk$set(fig.width=7,fig.height=10)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(Biostrings)
library(ggplot2)
library(gridExtra)
library(SpatialExperiment)
library(spatialLIBD)
require(colorout)
library(dreamlet)
library(BiocParallel)
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")

theme_set(theme_bw()+theme(axis.text.x = element_text(size = 14), axis.title.x = element_text(size = 16), axis.text.y = element_text(size = 14), axis.title.y = element_text(size =16), plot.title = element_text(size = 20,hjust=0.5), strip.text = element_text(size=18), legend.text = element_text(size=10), legend.title = element_text(size=11,hjust=0.5)))
```

```{r}
### load hyp sex de and process equivalently
hyp2 <- readRDS("data/processing/hyp_umi600_gene450_chrm35_UNNORM_trimmedD07-075_B1_rotsAndMirrors.RDS")
demos <- fread("raw-data/demos.txt")

tmpcd <- as.data.table(colData(hyp2),keep.rownames=T)
tmpcd <- merge.data.table(tmpcd,demos[,.(BrNum,Sex,PMI)],by.x = "brnum",by.y="BrNum")
tmpcd <- DataFrame(tmpcd)
rownames(tmpcd) <- tmpcd$rn
tmpcd <- tmpcd[colnames(hyp2),]
colData(hyp2) <- tmpcd
colData(hyp2)$Sex <- as.factor(colData(hyp2)$Sex)

rm(tmpcd)
## append clusters
bscl <- fread("analysis/data/spe_053123/H02-clustering/03-bs_harmony_hvg1020_nnsvg1020_9-15-20-31_out/BSpace_Harmony_nnsvg10pctile_15.txt")
bscl <- bscl[rn %in% colnames(hyp2)]
setnames(bscl,2,"label")
bscl[,label:=paste("x",label,sep = "")]
bscl <- DataFrame(bscl)
rownames(bscl) <- bscl$rn
bscl <- bscl[colnames(hyp2),]
colLabels(hyp2) <- as.factor(bscl$label)

rm(bscl)
# row names as genes for ease of interpretation; drop duplicated gene names
rownames(hyp2) <- rowData(hyp2)$gene_name
dups <- as.data.table(rownames(hyp2))
dups <- dups[,.N,by="V1"]
keeps <- dups[N==1,V1]
hyp2 <- hyp2[keeps,]

rm(dups,keeps)
```



# dreamlet
```{r}
sbp <- MulticoreParam(11)

proc <- dreamlet::aggregateToPseudoBulk(hyp2,sample_id="sample_id",cluster_id = "label",BPPARAM = sbp)

## consider all genes (min.counts=1 , as was done for mouse)
dif <- dreamlet::processAssays(proc,min.cells = 10,min.count = 1,min.samples = 4,min.prop = 0.4,normalize.method = "TMM",useCountsWeights = T,BPPARAM = sbp,formula = ~Sex)

sexdif <- dreamlet::dreamlet(dif,formula = ~Sex,BPPARAM = sbp)

# find relevant coefficient name
coefNames(sexdif)
#
sexdif2 <- dreamlet::topTable(sexdif,coef="SexM",number=Inf,adjust.method ="BH")
sexdif2 <- as.data.table(sexdif2,keep.rownames=T)

saveRDS(sexdif2,"analysis/data/spe_053123/H07-Outside Dataset Analyses and Comparisons/spatialHYP_dreamletSexDE.RDS")
rm(sexdif,dif)
```


#### for shits and gigs, also try this with random effect of brain number (i.e. donor), since DREAM enables us to do that here. we can still use the same pseudobulk object (proc) from above.
```{r}
sbp <- MulticoreParam(11)

dif.donorrand <- dreamlet::processAssays(proc,min.cells = 10,min.count = 1,min.samples = 4,min.prop = 0.4,normalize.method = "TMM",useCountsWeights = T,BPPARAM = sbp,formula = ~Sex.x+(1|brnum))

sexdif.donorrand <- dreamlet::dreamlet(dif.donorrand,formula = ~Sex.x+(1|brnum),BPPARAM = sbp)

sexdif2.donorrand <- dreamlet::topTable(sexdif.donorrand,coef="Sex.xM",number=Inf,adjust.method ="BH")
sexdif2.donorrand <- as.data.table(sexdif2.donorrand,keep.rownames=T)

saveRDS(sexdif2.donorrand,"analysis/data/spe_053123/H07-Outside Dataset Analyses and Comparisons/spatialHYP_dreamletSexDE_brnum-as-random-effect-inDEmodel.RDS")
```

