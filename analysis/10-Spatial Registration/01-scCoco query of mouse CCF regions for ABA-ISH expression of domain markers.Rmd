---
title: "01-scCoco query of mouse CCF regions for ABA-ISH expression of domain markers"
author: "Bernard Mulvey"
date: "2023-12-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
knitr::opts_chunk$set(fig.width=7,fig.height=10)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(Biostrings)
library(scCoco)
require(colorout)
library(stringr)
source("~/.R/calc_tau_for_cellOrTissueSpecificity_metric.R")
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")

## change write.table to output a TSV without quotes or rownames by default
library(default)
default(write.table) <- list(row.names=F,col.names=T,sep='\t',quote=F)

## enable forked parallel processing with BiocParallel::multicoreParam, future::, etc
library(parallelly)
options(parallelly.supportsMulticore.disableOn="")
options(parallelly.fork.enable=TRUE)
library(BiocParallel)
options(bphost="localhost")
```

```{r}
hypmark <- readRDS("data/07-Marker_genes/01b-BSpace_allruns_spatialLIBD-regwrap-enrichment_full.RDS")

hypmark <- hypmark[grep(names(hypmark),pattern="HARMONYlmbna_nnsvg10_60kiter",value=T)]

## retrieve top 150 markers for each cluster from these four clustering runs -- the query space is allen atlas ISH which only covers a few thousand genes, and we want to map to regions with at least 50 of our genes assayed

markerqueries <- list()
i<-1
for (i in c(1:length(hypmark))){
    markerqueries[[i]] <- list()
    tmp <- copy(hypmark[[i]])
    spdoms <- grep(names(tmp),pattern="logFC",value=T)
    spdoms <- gsub(spdoms,pattern="logFC_(.*)",replacement="\\1")
    j <- 1
    for (j in c(1:length(spdoms))){
        setorderv(tmp,paste0("logFC_",spdoms[j]),-1)
        # convert symbol to mouse symbol
        g <- stringr::str_to_title(tmp[1:150,gene])
        markerqueries[[i]][[j]] <- g
        names(markerqueries[[i]])[j] <- paste0(names(hypmark)[i],"_",spdoms[j])
        rm(g)
    }
    names(markerqueries)[i] <- names(hypmark)[i]
    rm(j,tmp,spdoms)
}
rm(i)
gc(full=T)
```

```{r}
sbp <- MulticoreParam(4)

### query CCF regions of mouse hypothalamus (parent structure 1097, right there in the documentation thankfully). cannot parallelize this step.
cocoqueryres <- list()
i<-1
for (i in c(1:length(markerqueries))){
    cocoqueryres[[i]] <- scCoco::findRegions_genesets(gene_set = markerqueries[[i]],min_ids = 50,target_structure_id=1097)
    names(cocoqueryres)[i] <- names(markerqueries)[i]
}
```

### save
```{r}
saveRDS(cocoqueryres,"data/10-Spatial Registration/01-scCoco query of top 150 markers per k15-20-31-collapsedK15 domain in ABA ms hyp CCF areas.RDS")
```

### session info
```{r}
sessionInfo()
sessioninfo::session_info()
```
R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.6

Matrix products: default
BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] stats4    stats     graphics  grDevices utils     datasets  methods  
[8] base     

other attached packages:
 [1] purrr_1.0.2         xml2_1.3.6          stringr_1.5.1      
 [4] BiocParallel_1.36.0 parallelly_1.36.0   default_1.0.0      
 [7] colorout_1.3-0      scCoco_0.0.0.9000   Biostrings_2.70.1  
[10] GenomeInfoDb_1.38.2 XVector_0.42.0      IRanges_2.36.0     
[13] S4Vectors_0.40.2    BiocGenerics_0.48.1 data.table_1.14.10 
[16] rlang_1.1.2        

loaded via a namespace (and not attached):
 [1] utf8_1.2.4              generics_0.1.3          bitops_1.0-7           
 [4] stringi_1.8.3           digest_0.6.33           magrittr_2.0.3         
 [7] evaluate_0.23           fastmap_1.1.1           rprojroot_2.0.4        
[10] jsonlite_1.8.8          sessioninfo_1.2.2       fansi_1.0.6            
[13] codetools_0.2-19        cli_3.6.2               crayon_1.5.2           
[16] withr_2.5.2             yaml_2.3.8              tools_4.3.1            
[19] parallel_4.3.1          dplyr_1.1.4             GenomeInfoDbData_1.2.11
[22] cocoframer_0.1.1        here_1.0.1              curl_5.2.0             
[25] vctrs_0.6.5             R6_2.5.1                lifecycle_1.0.4        
[28] zlibbioc_1.48.0         pkgconfig_2.0.3         pillar_1.9.0           
[31] glue_1.6.2              xfun_0.41               tibble_3.2.1           
[34] tidyselect_1.2.0        rstudioapi_0.15.0       knitr_1.45             
[37] htmltools_0.5.7         rmarkdown_2.25          compiler_4.3.1         
[40] RCurl_1.98-1.13        
> sessioninfo::session_info()
─ Session info ───────────────────────────────────────────────────────────
 setting  value
 version  R version 4.3.1 (2023-06-16)
 os       macOS Ventura 13.6
 system   aarch64, darwin20
 ui       RStudio
 language (EN)
 collate  en_US.UTF-8
 ctype    en_US.UTF-8
 tz       America/Chicago
 date     2023-12-23
 rstudio  2023.09.1+494 Desert Sunflower (desktop)
 pandoc   3.1.1 @ /Applications/RStudio.app/Contents/Resources/app/quarto/bin/tools/ (via rmarkdown)

─ Packages ───────────────────────────────────────────────────────────────
 package          * version    date (UTC) lib source
 BiocGenerics     * 0.48.1     2023-11-02 [1] Bioconductor
 BiocParallel     * 1.36.0     2023-10-26 [1] Bioconductor
 Biostrings       * 2.70.1     2023-10-26 [1] Bioconductor
 bitops             1.0-7      2021-04-24 [1] CRAN (R 4.3.0)
 cli                3.6.2      2023-12-11 [1] CRAN (R 4.3.1)
 cocoframer         0.1.1      2023-11-14 [1] Github (AllenInstitute/cocoframer@1de30a8)
 codetools          0.2-19     2023-02-01 [1] CRAN (R 4.3.0)
 colorout         * 1.3-0      2023-11-01 [1] local (/Users/bmulvey/Desktop/colorout)
 crayon             1.5.2      2022-09-29 [1] CRAN (R 4.3.0)
 curl               5.2.0      2023-12-08 [1] CRAN (R 4.3.1)
 data.table       * 1.14.10    2023-12-08 [1] CRAN (R 4.3.1)
 default          * 1.0.0      2017-08-07 [1] CRAN (R 4.3.0)
 digest             0.6.33     2023-07-07 [1] CRAN (R 4.3.0)
 dplyr              1.1.4      2023-11-17 [1] CRAN (R 4.3.1)
 evaluate           0.23       2023-11-01 [1] CRAN (R 4.3.1)
 fansi              1.0.6      2023-12-08 [1] CRAN (R 4.3.1)
 fastmap            1.1.1      2023-02-24 [1] CRAN (R 4.3.0)
 generics           0.1.3      2022-07-05 [1] CRAN (R 4.3.0)
 GenomeInfoDb     * 1.38.2     2023-12-13 [1] Bioconductor 3.18 (R 4.3.1)
 GenomeInfoDbData   1.2.11     2023-11-10 [1] Bioconductor
 glue               1.6.2      2022-02-24 [1] CRAN (R 4.3.0)
 here               1.0.1      2020-12-13 [1] CRAN (R 4.3.0)
 htmltools          0.5.7      2023-11-03 [1] CRAN (R 4.3.1)
 IRanges          * 2.36.0     2023-10-26 [1] Bioconductor
 jsonlite           1.8.8      2023-12-04 [1] CRAN (R 4.3.1)
 knitr              1.45       2023-10-30 [1] CRAN (R 4.3.1)
 lifecycle          1.0.4      2023-11-07 [1] CRAN (R 4.3.1)
 magrittr           2.0.3      2022-03-30 [1] CRAN (R 4.3.0)
 parallelly       * 1.36.0     2023-05-26 [1] CRAN (R 4.3.0)
 pillar             1.9.0      2023-03-22 [1] CRAN (R 4.3.0)
 pkgconfig          2.0.3      2019-09-22 [1] CRAN (R 4.3.0)
 purrr            * 1.0.2      2023-08-10 [1] CRAN (R 4.3.0)
 R6                 2.5.1      2021-08-19 [1] CRAN (R 4.3.0)
 RCurl              1.98-1.13  2023-11-02 [1] CRAN (R 4.3.1)
 rlang            * 1.1.2      2023-11-04 [1] CRAN (R 4.3.1)
 rmarkdown          2.25       2023-09-18 [1] CRAN (R 4.3.1)
 rprojroot          2.0.4      2023-11-05 [1] CRAN (R 4.3.1)
 rstudioapi         0.15.0     2023-07-07 [1] CRAN (R 4.3.0)
 S4Vectors        * 0.40.2     2023-11-25 [1] Bioconductor 3.18 (R 4.3.2)
 scCoco           * 0.0.0.9000 2023-11-14 [1] Github (lsteuernagel/scCoco@efffc50)
 sessioninfo        1.2.2      2021-12-06 [1] CRAN (R 4.3.0)
 stringi            1.8.3      2023-12-11 [1] CRAN (R 4.3.1)
 stringr          * 1.5.1      2023-11-14 [1] CRAN (R 4.3.1)
 tibble             3.2.1      2023-03-20 [1] CRAN (R 4.3.0)
 tidyselect         1.2.0      2022-10-10 [1] CRAN (R 4.3.0)
 utf8               1.2.4      2023-10-22 [1] CRAN (R 4.3.1)
 vctrs              0.6.5      2023-12-01 [1] CRAN (R 4.3.1)
 withr              2.5.2      2023-10-30 [1] CRAN (R 4.3.1)
 xfun               0.41       2023-11-01 [1] CRAN (R 4.3.1)
 xml2             * 1.3.6      2023-12-04 [1] CRAN (R 4.3.1)
 XVector          * 0.42.0     2023-10-26 [1] Bioconductor
 yaml               2.3.8      2023-12-11 [1] CRAN (R 4.3.1)
 zlibbioc           1.48.0     2023-10-26 [1] Bioconductor

 [1] /Users/bmulvey/Library/R/arm64/4.3/library
 [2] /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/library

──────────────────────────────────────────────────────────────────────────
