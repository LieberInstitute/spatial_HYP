---
title: "02-Calculate Sex DE by subclass for Yao23 mouse hypothalamus"
author: "Bernard Mulvey"
date: "2024-01-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
knitr::opts_chunk$set(fig.width=7,fig.height=10)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(Biostrings)
library(ggplot2)
library(gridExtra)
library(SpatialExperiment)
library(spatialLIBD)
require(colorout)
library(dreamlet)
library(BiocParallel)
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")

theme_set(theme_bw()+theme(axis.text.x = element_text(size = 14), axis.title.x = element_text(size = 16), axis.text.y = element_text(size = 14), axis.title.y = element_text(size =16), plot.title = element_text(size = 20,hjust=0.5), strip.text = element_text(size=18), legend.text = element_text(size=10), legend.title = element_text(size=11,hjust=0.5)))
```

### set up of yao 23 data wasa done in previous script (JHPCE currently can run zellkonverter but not dreamlet; local machine can run dreamlet but not zellkonverter)

data obtained from NeMO identifiers nemo:dat-kjseyhn and nemo:dat5ue6x8t and Brain Image Library
	1. https://data.nemoarchive.org/publication_release/ under bundle name â€˜Zeng_transcriptome_Allen_10x_cells_wholebrain_2023'
```{r}
bothhyp <- readRDS("raw-data/ABA_Whole_Mouse_Brain_Yao23_HYP/bothdatasets_raw_asSCE.RDS")
```

calculate sex diffs with random effect of donor (to account for multiple samples from same donor) for each subclass and supertype
```{r}
sbp <- MulticoreParam(10)

## subclass (218 types); samples labeled by library label; unique donor mice by donor_label
subag <- aggregateToPseudoBulk(bothhyp,sample_id = "library_label.x",cluster_id = "subclass",assay = "counts",BPPARAM = sbp)

subdif <- dreamlet::processAssays(subag,min.cells = 10,min.count = 1,min.samples = 4,min.prop = 0.4,normalize.method = "TMM",useCountsWeights = T,formula = ~donor_sex+(1|donor_label),BPPARAM = sbp)

subdif <- dreamlet::dreamlet(subdif,BPPARAM = sbp,formula = ~donor_sex+(1|donor_label))

subdif2 <- dreamlet::topTable(subdif,coef="donor_sexM",number=Inf,adjust.method ="BH")
subdif2 <- as.data.table(subdif2)

## make table of n cells per subclass
ncells <- as.data.table(table(bothhyp$subclass))

fwrite(subdif2,"data/12-Mouse comparisons/02-Yao23-HYP-subclass-sexDE_dreamlet_donormouse-ranfx.txt",sep='\t',quote=F,row.names=F)
fwrite(ncells,"data/12-Mouse comparisons/02-Yao23-HYP-ncells-per-subclass.txt",sep='\t',quote=F,row.names=F)
```
