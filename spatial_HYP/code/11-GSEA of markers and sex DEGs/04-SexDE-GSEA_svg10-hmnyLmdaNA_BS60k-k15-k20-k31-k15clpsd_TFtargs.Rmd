---
title: "04-Sex DE TF-Target GSEA"
author: "Bernard Mulvey"
date: "2024-07-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
knitr::opts_chunk$set(fig.width=7,fig.height=10)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(Biostrings)
library(BiocParallel)
library(parallel)
library(parallelly)
library(fgsea)

require(colorout)
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")

## change write.table to output a TSV without quotes or rownames by default
library(default)
default(write.table) <- list(row.names=F,col.names=T,sep='\t',quote=F)

## enable forked parallel processing with BiocParallel::multicoreParam, future::, etc
options(parallelly.supportsMulticore.disableOn="")
options(parallelly.fork.enable=TRUE)
options(bphost="localhost")

```

load dreamlet random effect sex DE stats, which were only run for the four clusterings of interest to begin with

```{r}
sexde <- readRDS("processed-data/09-Sex DE/01-voomLmFit_svg10-svg20-hvg20_Hmnydflt-mnn30-HmnylmbNA_BS-15-20-31-15VMHARCclpsd.RDS")

sexde <- sexde[grep(names(sexde),pattern="HARMONYlmbna_nnsvg10")]

# check:
# names(sexde)
# [1] "k15_HARMONYlmbna_nnsvg10"          
# [2] "k20_HARMONYlmbna_nnsvg10"          
# [3] "k31_HARMONYlmbna_nnsvg10"          
# [4] "k15_HARMONYlmbna_nnsvg10_clpsdARC_clpsdVMH"

```

### Enrichr TF-target databases gene sets retrieval
```{r}
tftargsets <- readRDS("data/11-GSEA/00a-enrichrTFsets_forfgseainput.RDS")
```

# MARKER gsea for TF-target sets
# note that we need SYMBOLS ("gene" column), not ens IDs in this case. the TF-target lists are only available as symbols
```{r}
### drop mito genes and chr X, Y genes
sexde <- lapply(sexde,FUN=function(x){x[!(chromosome_name %in% grep(chromosome_name,pattern="MT|X|Y",value=T))]})

### get named vectors of marker t-stats for each cluster in each result set (max 15+20+31+13)=79; probably less for clusters that dropped from spatiallibd due to poor representation
sexdelist <- list()
i<-1
for (i in c(1:length(sexde))){
    sdoms <- unique(sexde[[i]]$assay)
    setnames(sexde[[i]],"t","tstat")
    j<-1
    for (j in c(1:length(sdoms))){
        tmp <- copy(sexde[[i]][assay==sdoms[j]])[,.(gene_name,tstat)]
        setorderv(tmp,"tstat",-1)
        ## get the stat column as a vector and give it the gene ids as names for fgsea
        ## note that since data.table (invisibly) uses list() for column data, its cleaner to just make the working table a data frame for this last bit
        tmp <- as.data.frame(tmp)
        v <- tmp$tstat
        names(v) <- tmp$gene_name
        sexdelist[[length(sexdelist)+1]] <- v
        names(sexdelist)[length(sexdelist)] <- paste0(names(sexde)[i],"_",sdoms[j])
        rm(v,tmp)
    }
    rm(j,sdoms)
}
rm(i)
```

### run fgsea
### looping through each domain (each run is very fast with 10 cpus in biocparallel, so just serially run 10cpu GSEA for each cluster)

```{r}
sbp <- MulticoreParam(10)
register(sbp)
sexderes <- mapply(X=sexdelist,Y=names(sexdelist),SIMPLIFY=FALSE,FUN=function(X,Y){
    z<-as.data.table(fgseaMultilevel(pathways=tftargsets,stats = X,minSize = 15,maxSize = 500,eps=0.0,BPPARAM = sbp,nPermSimple = 50000))
    z[,spdom:=Y]
    return(z)
})
names(sexderes) <- names(sexdelist)

saveRDS(sexderes,"data/11-GSEA/04a-Sex DE TF-target GSEA svg10-hmnyLmdaNA_BS60k-k15-k20-k31-k15clpsd.RDS")

### collapse pathways-this part is WAY WAY slower than the GSEA itself
sbp <- MulticoreParam(5)
register(sbp)

sexderes2 <- mcmapply(X=sexderes,Y=sexdelist,SIMPLIFY = FALSE, mc.cores=10,FUN=function(X,Y){
    tmpres <- fgsea::collapsePathways(fgseaRes = X,stats=Y,pathways = tftargsets)
    return(tmpres)
})
names(sexderes2) <- names(sexderes)

saveRDS(sexderes2,"data/11-GSEA/04b-Sex DE TF-target fGSEA-collapsePathways output.RDS")

rm(sexdelist,sexde)
gc(full=T)

### subset to main enrichments
sexderes3 <- mapply(X=sexderes,Y=sexderes2,SIMPLIFY = FALSE,FUN=function(X,Y){
    X[pathway %in% Y[[1]]]
})
saveRDS(sexderes3,"data/11-GSEA/04c-Sex DE TF-target GSEA clpspath mainPathways-only.RDS")
```

```{r}
sessionInfo()
sessioninfo::session_info()
```
R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.6

Matrix products: default
BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] parallel  stats4    stats     graphics  grDevices utils     datasets 
[8] methods   base     

other attached packages:
 [1] fgsea_1.28.0        BiocParallel_1.36.0 parallelly_1.36.0  
 [4] default_1.0.0       colorout_1.3-0      gridExtra_2.3      
 [7] ggplot2_3.4.4       Biostrings_2.70.1   GenomeInfoDb_1.38.2
[10] XVector_0.42.0      IRanges_2.36.0      S4Vectors_0.40.2   
[13] BiocGenerics_0.48.1 data.table_1.14.10  rlang_1.1.2        

loaded via a namespace (and not attached):
 [1] tidyselect_1.2.0        viridisLite_0.4.2       dplyr_1.1.4            
 [4] farver_2.1.1            bitops_1.0-7            fastmap_1.1.1          
 [7] RCurl_1.98-1.13         tweenr_2.0.2            promises_1.2.1         
[10] digest_0.6.33           mime_0.12               lifecycle_1.0.4        
[13] ellipsis_0.3.2          magrittr_2.0.3          compiler_4.3.1         
[16] tools_4.3.1             igraph_1.6.0            utf8_1.2.4             
[19] yaml_2.3.8              knitr_1.45              labeling_0.4.3         
[22] htmlwidgets_1.6.4       here_1.0.1              plyr_1.8.9             
[25] xml2_1.3.6              babelgene_22.9          withr_2.5.2            
[28] purrr_1.0.2             grid_4.3.1              polyclip_1.10-6        
[31] fansi_1.0.6             xtable_1.8-4            colorspace_2.1-0       
[34] scales_1.3.0            MASS_7.3-60             cli_3.6.2              
[37] hypeR_2.0.0             rmarkdown_2.25          crayon_1.5.2           
[40] generics_0.1.3          rstudioapi_0.15.0       reshape2_1.4.4         
[43] httr_1.4.7              visNetwork_2.1.2        sessioninfo_1.2.2      
[46] ggforce_0.4.1           stringr_1.5.1           zlibbioc_1.48.0        
[49] rvest_1.0.3             msigdbr_7.5.1           vctrs_0.6.5            
[52] webshot_0.5.5           Matrix_1.6-4            jsonlite_1.8.8         
[55] systemfonts_1.0.5       glue_1.6.2              codetools_0.2-19       
[58] cowplot_1.1.2           stringi_1.8.3           gtable_0.3.4           
[61] later_1.3.2             munsell_0.5.0           tibble_3.2.1           
[64] pillar_1.9.0            htmltools_0.5.7         reactable_0.4.4        
[67] GenomeInfoDbData_1.2.11 R6_2.5.1                rprojroot_2.0.4        
[70] shiny_1.8.0             evaluate_0.23           kableExtra_1.3.4       
[73] lattice_0.22-5          openxlsx_4.2.5.2        httpuv_1.6.13          
[76] Rcpp_1.0.11             zip_2.3.0               fastmatch_1.1-4        
[79] svglite_2.1.3           xfun_0.41               pkgconfig_2.0.3        
> sessioninfo::session_info()
─ Session info ───────────────────────────────────────────────────────────
 setting  value
 version  R version 4.3.1 (2023-06-16)
 os       macOS Ventura 13.6
 system   aarch64, darwin20
 ui       RStudio
 language (EN)
 collate  en_US.UTF-8
 ctype    en_US.UTF-8
 tz       America/Chicago
 date     2023-12-28
 rstudio  2023.09.1+494 Desert Sunflower (desktop)
 pandoc   3.1.1 @ /Applications/RStudio.app/Contents/Resources/app/quarto/bin/tools/ (via rmarkdown)

─ Packages ───────────────────────────────────────────────────────────────
 package          * version   date (UTC) lib source
 babelgene          22.9      2022-09-29 [1] CRAN (R 4.3.0)
 BiocGenerics     * 0.48.1    2023-11-02 [1] Bioconductor
 BiocParallel     * 1.36.0    2023-10-26 [1] Bioconductor
 Biostrings       * 2.70.1    2023-10-26 [1] Bioconductor
 bitops             1.0-7     2021-04-24 [1] CRAN (R 4.3.0)
 cli                3.6.2     2023-12-11 [1] CRAN (R 4.3.1)
 codetools          0.2-19    2023-02-01 [1] CRAN (R 4.3.0)
 colorout         * 1.3-0     2023-11-01 [1] local (/Users/bmulvey/Desktop/colorout)
 colorspace         2.1-0     2023-01-23 [1] CRAN (R 4.3.0)
 cowplot            1.1.2     2023-12-15 [1] CRAN (R 4.3.1)
 crayon             1.5.2     2022-09-29 [1] CRAN (R 4.3.0)
 data.table       * 1.14.10   2023-12-08 [1] CRAN (R 4.3.1)
 default          * 1.0.0     2017-08-07 [1] CRAN (R 4.3.0)
 digest             0.6.33    2023-07-07 [1] CRAN (R 4.3.0)
 dplyr              1.1.4     2023-11-17 [1] CRAN (R 4.3.1)
 ellipsis           0.3.2     2021-04-29 [1] CRAN (R 4.3.0)
 evaluate           0.23      2023-11-01 [1] CRAN (R 4.3.1)
 fansi              1.0.6     2023-12-08 [1] CRAN (R 4.3.1)
 farver             2.1.1     2022-07-06 [1] CRAN (R 4.3.0)
 fastmap            1.1.1     2023-02-24 [1] CRAN (R 4.3.0)
 fastmatch          1.1-4     2023-08-18 [1] CRAN (R 4.3.0)
 fgsea            * 1.28.0    2023-10-24 [1] Bioconductor
 generics           0.1.3     2022-07-05 [1] CRAN (R 4.3.0)
 GenomeInfoDb     * 1.38.2    2023-12-13 [1] Bioconductor 3.18 (R 4.3.1)
 GenomeInfoDbData   1.2.11    2023-11-10 [1] Bioconductor
 ggforce            0.4.1     2022-10-04 [1] CRAN (R 4.3.0)
 ggplot2          * 3.4.4     2023-10-12 [1] CRAN (R 4.3.1)
 glue               1.6.2     2022-02-24 [1] CRAN (R 4.3.0)
 gridExtra        * 2.3       2017-09-09 [1] CRAN (R 4.3.0)
 gtable             0.3.4     2023-08-21 [1] CRAN (R 4.3.0)
 here               1.0.1     2020-12-13 [1] CRAN (R 4.3.0)
 htmltools          0.5.7     2023-11-03 [1] CRAN (R 4.3.1)
 htmlwidgets        1.6.4     2023-12-06 [1] CRAN (R 4.3.1)
 httpuv             1.6.13    2023-12-06 [1] CRAN (R 4.3.1)
 httr               1.4.7     2023-08-15 [1] CRAN (R 4.3.0)
 hypeR              2.0.0     2023-10-24 [1] Bioconductor
 igraph             1.6.0     2023-12-11 [1] CRAN (R 4.3.1)
 IRanges          * 2.36.0    2023-10-26 [1] Bioconductor
 jsonlite           1.8.8     2023-12-04 [1] CRAN (R 4.3.1)
 kableExtra         1.3.4     2021-02-20 [1] CRAN (R 4.3.0)
 knitr              1.45      2023-10-30 [1] CRAN (R 4.3.1)
 labeling           0.4.3     2023-08-29 [1] CRAN (R 4.3.0)
 later              1.3.2     2023-12-06 [1] CRAN (R 4.3.1)
 lattice            0.22-5    2023-10-24 [1] CRAN (R 4.3.1)
 lifecycle          1.0.4     2023-11-07 [1] CRAN (R 4.3.1)
 magrittr           2.0.3     2022-03-30 [1] CRAN (R 4.3.0)
 MASS               7.3-60    2023-05-04 [1] CRAN (R 4.3.0)
 Matrix             1.6-4     2023-11-30 [1] CRAN (R 4.3.1)
 mime               0.12      2021-09-28 [1] CRAN (R 4.3.0)
 msigdbr            7.5.1     2022-03-30 [1] CRAN (R 4.3.0)
 munsell            0.5.0     2018-06-12 [1] CRAN (R 4.3.0)
 openxlsx           4.2.5.2   2023-02-06 [1] CRAN (R 4.3.0)
 parallelly       * 1.36.0    2023-05-26 [1] CRAN (R 4.3.0)
 pillar             1.9.0     2023-03-22 [1] CRAN (R 4.3.0)
 pkgconfig          2.0.3     2019-09-22 [1] CRAN (R 4.3.0)
 plyr               1.8.9     2023-10-02 [1] CRAN (R 4.3.1)
 polyclip           1.10-6    2023-09-27 [1] CRAN (R 4.3.1)
 promises           1.2.1     2023-08-10 [1] CRAN (R 4.3.0)
 purrr              1.0.2     2023-08-10 [1] CRAN (R 4.3.0)
 R6                 2.5.1     2021-08-19 [1] CRAN (R 4.3.0)
 Rcpp               1.0.11    2023-07-06 [1] CRAN (R 4.3.1)
 RCurl              1.98-1.13 2023-11-02 [1] CRAN (R 4.3.1)
 reactable          0.4.4     2023-03-12 [1] CRAN (R 4.3.0)
 reshape2           1.4.4     2020-04-09 [1] CRAN (R 4.3.0)
 rlang            * 1.1.2     2023-11-04 [1] CRAN (R 4.3.1)
 rmarkdown          2.25      2023-09-18 [1] CRAN (R 4.3.1)
 rprojroot          2.0.4     2023-11-05 [1] CRAN (R 4.3.1)
 rstudioapi         0.15.0    2023-07-07 [1] CRAN (R 4.3.0)
 rvest              1.0.3     2022-08-19 [1] CRAN (R 4.3.0)
 S4Vectors        * 0.40.2    2023-11-25 [1] Bioconductor 3.18 (R 4.3.2)
 scales             1.3.0     2023-11-28 [1] CRAN (R 4.3.1)
 sessioninfo        1.2.2     2021-12-06 [1] CRAN (R 4.3.0)
 shiny              1.8.0     2023-11-17 [1] CRAN (R 4.3.1)
 stringi            1.8.3     2023-12-11 [1] CRAN (R 4.3.1)
 stringr            1.5.1     2023-11-14 [1] CRAN (R 4.3.1)
 svglite            2.1.3     2023-12-08 [1] CRAN (R 4.3.1)
 systemfonts        1.0.5     2023-10-09 [1] CRAN (R 4.3.1)
 tibble             3.2.1     2023-03-20 [1] CRAN (R 4.3.0)
 tidyselect         1.2.0     2022-10-10 [1] CRAN (R 4.3.0)
 tweenr             2.0.2     2022-09-06 [1] CRAN (R 4.3.0)
 utf8               1.2.4     2023-10-22 [1] CRAN (R 4.3.1)
 vctrs              0.6.5     2023-12-01 [1] CRAN (R 4.3.1)
 viridisLite        0.4.2     2023-05-02 [1] CRAN (R 4.3.0)
 visNetwork         2.1.2     2022-09-29 [1] CRAN (R 4.3.0)
 webshot            0.5.5     2023-06-26 [1] CRAN (R 4.3.0)
 withr              2.5.2     2023-10-30 [1] CRAN (R 4.3.1)
 xfun               0.41      2023-11-01 [1] CRAN (R 4.3.1)
 xml2               1.3.6     2023-12-04 [1] CRAN (R 4.3.1)
 xtable             1.8-4     2019-04-21 [1] CRAN (R 4.3.0)
 XVector          * 0.42.0    2023-10-26 [1] Bioconductor
 yaml               2.3.8     2023-12-11 [1] CRAN (R 4.3.1)
 zip                2.3.0     2023-04-17 [1] CRAN (R 4.3.0)
 zlibbioc           1.48.0    2023-10-26 [1] Bioconductor

 [1] /Users/bmulvey/Library/R/arm64/4.3/library
 [2] /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/library

──────────────────────────────────────────────────────────────────────────
