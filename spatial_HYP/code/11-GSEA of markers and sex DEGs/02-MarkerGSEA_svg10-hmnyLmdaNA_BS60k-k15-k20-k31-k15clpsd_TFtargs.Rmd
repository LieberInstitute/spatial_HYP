---
title: "02-Marker TF-Target GSEA"
author: "Bernard Mulvey"
date: "2024-07-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
knitr::opts_chunk$set(fig.width=7,fig.height=10)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(Biostrings)
library(BiocParallel)
library(parallel)
library(parallelly)
library(fgsea)

require(colorout)
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")

## change write.table to output a TSV without quotes or rownames by default
library(default)
default(write.table) <- list(row.names=F,col.names=T,sep='\t',quote=F)

## enable forked parallel processing with BiocParallel::multicoreParam, future::, etc
options(parallelly.supportsMulticore.disableOn="")
options(parallelly.fork.enable=TRUE)
options(bphost="localhost")

```

load SpatialLIBD marker enrichment stats and subset to clusterings of interest
```{r}
mks <- readRDS("processed-data/07-Marker_genes/01b-BSpace_allruns_spatialLIBD-regwrap-enrichment_full.RDS")

mks <- mks[grep(names(mks),pattern="HARMONYlmbna_nnsvg10_60kiter")]
# check:
# names(mks)
# [1] "k15_HARMONYlmbna_nnsvg10_60kiter"          
# [2] "k20_HARMONYlmbna_nnsvg10_60kiter"          
# [3] "k31_HARMONYlmbna_nnsvg10_60kiter"          
# [4] "k15_HARMONYlmbna_nnsvg10_60kiter_collapsed"

```

### Enrichr TF-target databases gene sets retrieval
```{r}
tftargsets <- readRDS("processed-data/11-GSEA/00a-enrichrTFsets_forfgseainput.RDS")
```

# MARKER gsea for TF-target sets
# note that we need SYMBOLS ("gene" column), not ens IDs in this case. the TF-target lists are only available as symbols
```{r}
### drop mito genes
mks <- lapply(mks,FUN=function(x){x[!(gene %in% grep(gene,pattern="MT-",value=T))]})

### get named vectors of marker t-stats for each cluster in each result set (max 15+20+31+13)=79; probably less for clusters that dropped from spatiallibd due to poor representation
mklist <- list()
i<-1
for (i in c(1:length(mks))){
    sdoms <- grep(names(mks[[i]]),pattern="logFC_",value=T)
    sdoms <- gsub(sdoms,pattern="^logFC_(.*)$",replacement="\\1")
    j<-1
    for (j in c(1:length(sdoms))){
        getcol <- paste0("t_stat_",sdoms[j])
        tmp <- copy(mks[[i]])[,c("gene",..getcol)]
        setorderv(tmp,getcol,-1)
        ## get the stat column as a vector and give it the gene ids as names for fgsea
        ## note that since data.table (invisibly) uses list() for column data, its cleaner to just make the working table a data frame for this last bit
        setnames(tmp,getcol,"stat")
        tmp <- as.data.frame(tmp)
        v <- tmp$stat
        names(v) <- tmp$gene
        mklist[[length(mklist)+1]] <- v
        names(mklist)[length(mklist)] <- paste0(names(mks)[i],"_",sdoms[j])
        rm(getcol,v,tmp)
    }
    rm(j,sdoms)
}
rm(i,mks)
```

### run fgsea
### looping through each domain (each run is very fast with 10 cpus in biocparallel, so just serially run 10cpu GSEA for each cluster)

```{r}
sbp <- MulticoreParam(10)
register(sbp)
mkres <- mapply(X=mklist,Y=names(mklist),SIMPLIFY=FALSE,FUN=function(X,Y){
    z<-as.data.table(fgseaMultilevel(pathways=tftargsets,stats = X,minSize = 15,maxSize = 500,eps=0.0,BPPARAM = sbp,nPermSimple = 50000))
    z[,spdom:=Y]
    return(z)
})
names(mkres) <- names(mklist)
saveRDS(mkres,"processed-data/11-GSEA/02a-Marker TF-target GSEA svg10-hmnyLmdaNA_BS60k-k15-k20-k31-k15clpsd.RDS")

### collapse pathways-this part is WAY WAY slower than the GSEA itself and serialized, so bplapply it

mkres2 <- mcmapply(X=mkres,Y=mklist,SIMPLIFY = FALSE, mc.cores=9,FUN=function(X,Y){
    tmpres <- fgsea::collapsePathways(fgseaRes = X,stats=Y,pathways = tftargsets)
    return(tmpres)
})
names(mkres2) <- names(mkres)

saveRDS(mkres2,"processed-data/11-GSEA/02b-Marker TF-target fGSEA-collapsePathways output.RDS")

rm(mklist)
gc(full=T)

### subset to main enrichments
mkres3 <- mapply(X=mkres,Y=mkres2,SIMPLIFY = FALSE,FUN=function(X,Y){
    X[pathway %in% Y[[1]]]
})
saveRDS(mkres3,"processed-data/11-GSEA/02c-Marker TF-target GSEA clpspath mainPathways-only.RDS")
```

```{r}
sessionInfo()
sessioninfo::session_info()
```
