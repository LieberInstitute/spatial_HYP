---
title: "Supplemental Fig-Spotplots of NR5A1, NPY, MBP in all samples without rotations
  or mirrorings"
author: "Bernard Mulvey"
date: "2024-02-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
knitr::opts_chunk$set(fig.width=7,fig.height=10)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(Biostrings)
library(ggplot2)
library(gridExtra)
library(SpatialExperiment)
library(spatialLIBD)
require(colorout)
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")

## change write.table to output a TSV without quotes or rownames by default
library(default)
default(write.table) <- list(row.names=F,col.names=T,sep='\t',quote=F)

## enable forked parallel processing with BiocParallel::multicoreParam, future::, etc
library(parallelly)
options(parallelly.supportsMulticore.disableOn="")
options(parallelly.fork.enable=TRUE)
library(BiocParallel)
options(bphost="localhost")

theme_set(theme_bw()+theme(axis.text.x = element_text(size = 14), axis.title.x = element_text(size = 16), axis.text.y = element_text(size = 14), axis.title.y = element_text(size =16), plot.title = element_text(size = 20,hjust=0.5), strip.text = element_text(size=18), legend.text = element_text(size=10), legend.title = element_text(size=11,hjust=0.5)))
```

### load raw spe (i.e., no rotations, no mirrors); subset to spots and genes in the final filtered object for exactly comparable non-visual data;

```{r}
load("processed-data/02_build_spe/spe_raw_w_V13M13-362.Rdata")

hyp2 <- readRDS("data/03-QC_filters/hypN9_umi275_gene166_chrm50_lognorm_111723.RDS")

spe_raw <- spe_raw[rownames(spe_raw) %in% rownames(hyp2),][rownames(hyp2),]
spe_raw <- spe_raw[,colnames(spe_raw) %in% colnames(hyp2)][,colnames(hyp2)]

# move over logcounts info
assays(spe_raw)$logcounts <- assays(hyp2)$logcounts


rm(hyp2)
gc(full=T)

rownames(spe_raw) <- rowData(spe_raw)$gene_name
```

spotplot MBP, NPY, NR5A1 for comparisons w/ VMH/ARC localization RNAscopes in supp fig. plot three ways for heena: full pages by gene, strips w/ each gene for one sample, and individual plots.
 
### format 1: full pages by gene
```{r}
plotg <- c("MBP","NPY","NR5A1")

i <- 1
for (i in c(1:length(plotg))){
    plt <- vis_grid_gene(spe = spe_raw,geneid=plotg[i], 
                         pdf_file=NULL, 
                         return_plots=T, 
                         spatial=T, 
                         point_size=1,
                         alpha=0.65,
                         viridis=FALSE,
                         na_color = NA,
                         auto_crop = T)
    # adjust formatting for pdf
    plt <- lapply(plt,FUN=function(x){x+
            theme(plot.title = element_text(size = 11,hjust=0.5),
                  strip.text = element_text(size=10),
                  legend.text = element_text(size=10),
                  legend.title = element_text(size=10,hjust=0.5))
        })
    pdf(paste0("plots/Manuscript/Supp Panels-NR5A1-NPY-MBP spotplots/Full page by gene/",plotg[i],".pdf"),height=8,width=10)
    do.call("grid.arrange",plt)
    dev.off()
}

```


### format 2: panel strips of all genes, single samples. (height = 1.2 inch, strip width = 3.75 in)
### geez, that took a lot of margin tinkering
```{r}
sbp <- MulticoreParam(4)
register(sbp)

samps <- unique(spe_raw$sample_id)
bplapply(samps,BPPARAM = sbp,function(s){
    plt<-list()
    i <- 1
    for (i in c(1:length(plotg))){
        plt[[i]] <- vis_gene(spe = spe_raw,
                             sampleid=s,
                             geneid = plotg[i],
                             pdf_file=NULL,
                             return_plots=T,
                             spatial=T,
                             point_size=0.4,
                             alpha=0.65,
                             viridis=FALSE,
                             na_color = NA,
                             auto_crop = T,
                             height=1.2,
                             width=1.25)
    # adjust formatting for pdf
    plt[[i]] <- plt[[i]]+
        theme(plot.title = element_text(size=8,
                                        hjust=0.5,
                                        margin=
                                            margin(0,0,0,0,unit="in")),
              legend.box = element_blank(),
              legend.justification = "right",
              strip.text = element_blank(),
              legend.text = element_text(size=4),
              legend.title = element_blank(),
              plot.margin = margin(0.1,0,-0.35,-0.3,unit = "in"),
              legend.spacing.x = unit(0.005,"in"),
              legend.key.height = unit(0.1,"in"),
              legend.key.width = unit(0.05,"in"),
              legend.margin = margin(-0.15,0,0,0,"in"))+
        ggtitle(plotg[i])
    }
    pdf(paste0("plots/Manuscript/Supp Panels-NR5A1-NPY-MBP spotplots/Strips per sample/",s,".pdf"),height=1.2,width=3.75)
    do.call("grid.arrange",c(plt,ncol=3))
    dev.off()
})

```

## format 3: individual plots
```{r}
sbp <- MulticoreParam(8)
register(sbp)

samps <- unique(spe_raw$sample_id)
bplapply(samps,BPPARAM = sbp,function(s){
    i <- 1
    for (i in c(1:length(plotg))){
        plt <- vis_gene(spe = spe_raw,
                             sampleid=s,
                             geneid = plotg[i],
                             pdf_file=NULL,
                             return_plots=T,
                             spatial=T,
                             point_size=0.4,
                             alpha=0.65,
                             viridis=FALSE,
                             na_color = NA,
                             auto_crop = T,
                             height=1.2,
                             width=1.25)
    # adjust formatting for pdf
        plt <- plt+
            theme(plot.title = element_text(size=8,
                                            hjust=0.5,
                                            margin=
                                                margin(0,0,0,0,unit="in")),
                  legend.box = element_blank(),
                  legend.justification = "right",
                  strip.text = element_blank(),
                  legend.text = element_text(size=4),
                  legend.title = element_blank(),
                  plot.margin = margin(0.1,0,-0.25,-0.3,unit = "in"),
                  legend.spacing.x = unit(0.005,"in"),
                  legend.key.height = unit(0.1,"in"),
                  legend.key.width = unit(0.05,"in"),
                  legend.margin = margin(-0.15,0,0,0,"in"))+
            ggtitle(plotg[i])
    
        pdf(paste0("plots/Manuscript/Supp Panels-NR5A1-NPY-MBP spotplots/Single panels/",s,"_",plotg[i],".pdf"),height=1.2,width=1.25)
        print(plt)
        dev.off()
    }
})
```
